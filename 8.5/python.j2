from airflow import DAG
from airflow.operators.python import PythonOperator
from datetime import datetime, timedelta
import os
import sys
import importlib.util

# ========== Ğ”Ğ˜ĞĞĞœĞ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ˜ĞœĞŸĞĞ Ğ¢ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ™ ==========
# ĞĞ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñƒ Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸
SCRIPT_PATH = "/opt/airflow/generator/script/python_functions.py"

if os.path.exists(SCRIPT_PATH):
    try:
        # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ
        spec = importlib.util.spec_from_file_location("python_functions", SCRIPT_PATH)
        python_functions = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(python_functions)

        # Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
        call_api = python_functions.call_api
        validate_json_data = python_functions.validate_json_data
        print("âœ… Imported functions from generator/script")

    except Exception as e:
        print(f"âŒ Error importing functions: {str(e)}")
        # Fallback to mock functions
        def call_api(**kwargs):
            print("ğŸ“¡ Mock API call")
            return {"status": "mock_success"}
        def validate_json_data(**kwargs):
            print("ğŸ” Mock validation")
            return {"valid": True}
else:
    print("âŒ Script not found: /opt/airflow/generator/script/python_functions.py")
    # Mock functions
    def call_api(**kwargs):
        print("ğŸ“¡ Mock API call (script not found)")
        return {"status": "mock_success"}
    def validate_json_data(**kwargs):
        print("ğŸ” Mock validation (script not found)")
        return {"valid": True}
# ========== ĞšĞĞĞ•Ğ¦ Ğ˜ĞœĞŸĞĞ Ğ¢Ğ ==========

def replace_templates(value, context):
    """Ğ—Ğ°Ğ¼ĞµĞ½Ğ° template Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…"""
    if isinstance(value, str):
        return value.replace("{{ ds }}", context['ds'])
    return value

{% for task in tasks %}
{% if task.task_type == "API_CALL" %}
def {{ task.task_id }}_wrapper(**kwargs):
    """Wrapper for API call"""
    params = {}
    {% for key, value in task.items() %}
    {% if key not in ['task_id', 'task_type'] %}
    params['{{ key }}'] = replace_templates({{ value | tojson }}, kwargs)
    {% endif %}
    {% endfor %}
    return call_api(**params)
{% endif %}

{% if task.task_type == "VALIDATION" %}
def {{ task.task_id }}_wrapper(**kwargs):
    """Wrapper for validation"""
    params = {}
    {% for key, value in task.items() %}
    {% if key not in ['task_id', 'task_type'] %}
    params['{{ key }}'] = replace_templates({{ value | tojson }}, kwargs)
    {% endif %}
    {% endfor %}
    return validate_json_data(**params)
{% endif %}
{% endfor %}

with DAG(
    dag_id="{{ dag_id }}",
    description="{{ description }}",
    start_date=datetime({{ start_date.year }}, {{ start_date.month }}, {{ start_date.day }}),
    schedule_interval="{{ schedule_interval }}",
    catchup={{ catchup }},
    max_active_runs={{ max_active_runs }},
    tags={{ tags }},
    default_args={
        "retries": {{ retries }},
        "retry_delay": timedelta(seconds={{ retry_delay }})
    }
) as dag:

    {% for task in tasks %}
    {{ task.task_id }} = PythonOperator(
        task_id="{{ task.task_id }}",
        python_callable={{ task.task_id }}_wrapper,
        provide_context=True
    )
    {% endfor %}

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
    {% for i in range(1, tasks|length) %}
    {{ tasks[i-1].task_id }} >> {{ tasks[i].task_id }}
    {% endfor %}